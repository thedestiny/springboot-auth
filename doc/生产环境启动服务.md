

df -l 
du -h --max-depth=1
yum install -y net-tools rzsz 

### tmux 后台启动程序代码

```
yum install -y tmux 
#### 进入应用程序
tmux a -t sss | tmux attach -t sss 
### 查看所有会话内容
tmux ls 
# 创建会话窗口
tmux new -s sss
tmux kill-session -t session-name 
退出会话窗口
ctrl + b 然后按 d 退出 
```


为了安全，绝对不要使用 root 用户运行业务代码。
```

# 创建一个没有登录权限的用户 app_user
sudo useradd -r -s /bin/false app_user
# 确保该用户对 jar 包有读取权限
sudo chownapp_user:app_user /opt/prod/app.jar
```

创建 service 单元文件，使用 .service 文件管理进程 
```
创建文件 /etc/systemd/system/myapp.service
[Unit]
Description=My SpringBoot Enterprise App
# 在网络服务启动后再启动
After=syslog.target network.target

[Service]
# 【关键】指定运行用户，实现权限隔离
User=app_user
Group=app_user

# 【核心】启动命令 (建议指定 JVM 参数)
ExecStart=/home/zml/.jdks/corretto-1.8.0_412/bin/java -Djava.ext.dirs=/home/zml/.jdks/corretto-1.8.0_412/jre/lib/ext:/home/zml/.jdks/corretto-1.8.0_412/lib/ext  -Xms512m -Xmx512m -Xmn256m -Xloggc:/opt/share/app/demo/logs/sso_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M -Dproject.home=/opt/share/app/sso -jar /opt/share/app/demo/myapp-user.jar  --server.max-http-header-size=524288 --spring.config.location=file:/opt/share/app/demo/config/

# 【关键】Spring Boot 优雅关闭
# 143 代表 SIGTERM 信号，Java 应用正常退出时的状态码
SuccessExitStatus=143

# 崩溃自动重启配置
Restart=always
RestartSec=10

# 日志由 Systemd 接管 (可用 journalctl 查看)
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=myapp

[Install]
WantedBy=multi-user.target

```


```

# 1. 重载配置
sudo systemctl daemon-reload

# 2. 设置开机自启 (从此告别重启焦虑)
sudo systemctl enable myapp

# 3. 启动服务
sudo systemctl start myapp
```

默认情况下，用户退出 SSH，用户下的 Systemd 进程会被杀掉。

```
# 检查方法,如果输出 Linger=no，则需要在服务器上执行一次开启操作。
loginctl show-user $USER --property=Linger
# 开启用户驻留，允许服务在用户注销后继续运行
sudo loginctl enable-linger <你的用户名>

配置文件位置变了，放在 ~/.config/systemd/user/ 下。
mkdir -p ~/.config/systemd/user
vim ~/.config/systemd/user/myapp.service
```

配置内容
```

[Unit]
Description=My User Space App
After=network.target

[Service]
# 注意：使用绝对路径
ExecStart=/home/zml/.jdks/corretto-1.8.0_412/bin/java -Djava.ext.dirs=/home/zml/.jdks/corretto-1.8.0_412/jre/lib/ext:/home/zml/.jdks/corretto-1.8.0_412/lib/ext  -Xms512m -Xmx512m -Xmn256m -Xloggc:/opt/share/app/demo/logs/sso_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M -Dproject.home=/opt/share/app/sso -jar /opt/share/app/demo/myapp-user.jar  --server.max-http-header-size=524288 --spring.config.location=file:/opt/share/app/demo/config/
SuccessExitStatus=143
Restart=always
RestartSec=10
SyslogIdentifier=myapp-user

[Install]
# 【注意】这里不同于系统级配置
WantedBy=default.target


# 启动
systemctl --user start myapp
# 开机自启 (随服务器启动)
systemctl --user enable myapp
# 查看日志
journalctl --user -u myapp -f
```


```
java 部署参数 说明
生产环境建议 -Xms 和 -Xmx 设置为相同值，避免内存抖动。

# springboot 2.3 + 版本 开启优雅关闭
server:
  shutdown: graceful
spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s
```


```config

server {
    listen 80;
    server_name www.your-company.com;

    # 【优化 1】解除上传文件大小限制
    # 默认只有 1M，生产环境建议设置为 100M 或更大
    client_max_body_size 100m; 

    location / {
         # 转发到本地 Systemd 跑的 Java 服务
        proxy_pass http://localhost:8080;
        
        # 【关键】透传真实 IP
        # 如果不加这些，Java 代码里的 request.getRemoteAddr() 拿到的全是 127.0.0.1
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        #长连接与超时设置 (解决 504 错误)
        # 建立连接超时时间 (通常默认 60s 够用)
        proxy_connect_timeout 60s;
        
        # 核心：后端处理等待时间
        # 如果你的 SpringBoot 有导出报表、发送邮件等长耗时任务，
        # 务必将此值调大，否则 Nginx 会掐断连接
        proxy_read_timeout 300s;
        
        # 发送请求超时时间
        proxy_send_timeout 300s;
    }
    # 动静分离：静态资源由 Nginx 直接处理，不经过 Java
    location /static/ {
        alias /opt/prod/static/;
        expires 30d;
    }
}

```


